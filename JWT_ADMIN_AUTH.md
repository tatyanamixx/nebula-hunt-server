# JWT Аутентификация для Админки

## Обзор

В админке Nebulahunt реализована JWT (JSON Web Token) аутентификация для безопасного доступа к административным функциям. Система использует два типа токенов:

-   **Access Token** - короткоживущий токен для доступа к API (15 минут)
-   **Refresh Token** - долгоживущий токен для обновления access token (30 дней)

## Архитектура

### Серверная часть

#### Middleware

-   `admin-auth-middleware.js` - проверяет JWT токены для админских маршрутов
-   `admin-middleware.js` - проверяет роль пользователя (устаревший, заменен на admin-auth-middleware)

#### Сервисы

-   `token-service.js` - генерирует и валидирует JWT токены
-   `admin-service.js` - бизнес-логика для админской аутентификации

#### Контроллеры

-   `admin-controller.js` - обработка HTTP запросов для админки

### Клиентская часть

#### Контекст

-   `AuthContext.tsx` - управление состоянием аутентификации
-   Автоматическое обновление токенов
-   Обработка истечения токенов

#### API

-   `api.ts` - HTTP клиент с автоматическим добавлением токенов
-   Автоматическое обновление токенов при 401 ошибках

## Маршруты

### Публичные маршруты (не требуют аутентификации)

```
POST /admin/oauth/google          - Google OAuth аутентификация
POST /admin/oauth/2fa/verify      - 2FA верификация
POST /admin/login                 - Email аутентификация (устаревший)
POST /admin/init                  - Инициализация админа
POST /admin/2fa/verify            - 2FA верификация
POST /admin/supervisor/init       - Инициализация супервизора
POST /admin/2fa/complete          - Завершение настройки 2FA
POST /admin/register              - Регистрация админа
GET  /admin/invite/validate       - Валидация приглашения
POST /admin/refresh               - Обновление JWT токена
```

### Защищенные маршруты (требуют JWT аутентификации)

```
POST /admin/logout                - Выход из системы
POST /admin/invite                - Отправка приглашения
GET  /admin/invites               - Получение списка приглашений
GET  /admin/stats                 - Получение статистики
```

## Использование

### 1. Аутентификация через Google OAuth

```typescript
// Клиентская часть
const { loginWithGoogle } = useAuth();

try {
	await loginWithGoogle();
	// Если требуется 2FA, пользователь будет перенаправлен на форму 2FA
} catch (error) {
	console.error('Ошибка аутентификации:', error);
}
```

### 2. 2FA Верификация

```typescript
// Клиентская часть
const { verify2FA } = useAuth();

try {
	await verify2FA(otpCode);
	// После успешной верификации пользователь получает токены
} catch (error) {
	console.error('Ошибка 2FA:', error);
}
```

### 3. Автоматическое обновление токенов

```typescript
// Клиентская часть
const { refreshToken } = useAuth();

try {
	await refreshToken();
	// Токены автоматически обновлены
} catch (error) {
	// Пользователь перенаправляется на страницу входа
}
```

### 4. Защищенные запросы

```typescript
// API клиент автоматически добавляет токены
const response = await api.get('/admin/stats');
```

## Структура JWT токенов

### Access Token Payload

```json
{
	"id": 123,
	"email": "admin@example.com",
	"name": "Admin User",
	"role": "ADMIN",
	"provider": "google",
	"providerId": "google_user_id",
	"iat": 1640995200,
	"exp": 1640996100,
	"iss": "nebulahunt-server",
	"aud": "nebulahunt-users"
}
```

### Refresh Token Payload

```json
{
	"id": 123,
	"type": "refresh",
	"version": 1640995200000,
	"iat": 1640995200,
	"exp": 1643587200,
	"iss": "nebulahunt-server",
	"aud": "nebulahunt-users"
}
```

## Безопасность

### Меры безопасности

1. **Короткое время жизни access token** (15 минут)
2. **Refresh token rotation** - при каждом обновлении создается новый refresh token
3. **Проверка роли** - только пользователи с ролью ADMIN могут получить доступ
4. **Проверка блокировки** - заблокированные пользователи не могут получить доступ
5. **Валидация токенов в базе данных** - refresh токены хранятся в БД

### Переменные окружения

```env
JWT_ACCESS_SECRET=your_access_secret_key
JWT_REFRESH_SECRET=your_refresh_secret_key
JWT_ACCESS_EXPIRES_IN=15m
JWT_REFRESH_EXPIRES_IN=30d
JWT_ISSUER=nebulahunt-server
JWT_ACCESS_AUDIENCE=nebulahunt-users
JWT_REFRESH_AUDIENCE=nebulahunt-users
```

## Тестирование

### Страница Token Info

Доступна по адресу `/token-info` для авторизованных пользователей. Показывает:

-   Информацию о пользователе
-   Статус токена (действительный/истекший)
-   Время истечения токена
-   Payload токена
-   Header токена
-   Подпись токена

### Функции тестирования

-   Кнопка "Refresh Token" для ручного обновления токена
-   Автоматическое обновление при истечении токена
-   Отображение ошибок аутентификации

## Обработка ошибок

### Типичные ошибки

-   `401 Unauthorized` - неверный или отсутствующий токен
-   `403 Forbidden` - недостаточно прав или заблокированный аккаунт
-   `TokenExpiredError` - истекший токен

### Автоматическое восстановление

1. При получении 401 ошибки система пытается обновить токен
2. Если обновление не удалось, пользователь перенаправляется на страницу входа
3. Все несохраненные данные теряются

## Миграция с старой системы

### Изменения в маршрутах

-   Заменен `adminMiddleware` на `adminAuthMiddleware` для всех защищенных маршрутов (завершено)
-   Добавлен новый маршрут `/admin/refresh` для обновления токенов

### Совместимость

-   Старые методы аутентификации (email + 2FA) остаются доступными
-   Google OAuth остается основным методом аутентификации
-   Все существующие функции админки продолжают работать

## Мониторинг и логирование

### Логирование

Все операции с токенами логируются:

-   Попытки аутентификации
-   Успешные/неуспешные обновления токенов
-   Попытки доступа к защищенным маршрутам
-   Ошибки валидации токенов

### Метрики

-   Количество активных сессий
-   Частота обновления токенов
-   Количество неуспешных попыток аутентификации
