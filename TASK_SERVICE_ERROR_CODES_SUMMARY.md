# TaskService - Полная интеграция с ERROR_CODES

## Обзор изменений

Все методы в `TaskService` были обновлены для использования системы кодов ошибок `error-codes.js` и улучшенного логирования.

## Обновленные методы

### 1. initializeUserTasks

-   ✅ Уже обновлен с `findOrCreate` и `ERROR_CODES`
-   Использует `ERROR_CODES.TASK.TASK_TEMPLATE_NOT_FOUND` и `ERROR_CODES.SYSTEM.DATABASE_ERROR`

### 2. getUserTasks

-   **Добавлено**: Детальное логирование начала и завершения операции
-   **Добавлено**: Использование `ERROR_CODES.SYSTEM.DATABASE_ERROR`
-   **Улучшено**: Обработка ошибок с проверкой `instanceof ApiError`

### 3. completeTask

-   **Добавлено**: Специфичные коды ошибок:
    -   `ERROR_CODES.TASK.TASK_TEMPLATE_NOT_FOUND` - шаблон задачи не найден
    -   `ERROR_CODES.TASK.TASK_NOT_FOUND` - задача пользователя не найдена
    -   `ERROR_CODES.SYSTEM.DATABASE_ERROR` - общие ошибки БД
-   **Улучшено**: Детальное логирование каждого этапа
-   **Исправлено**: Убраны лишние `rollback()` вызовы

### 4. getActiveTasks

-   **Добавлено**: Логирование количества активных задач
-   **Добавлено**: Использование `ERROR_CODES.SYSTEM.DATABASE_ERROR`
-   **Улучшено**: Обработка ошибок

### 5. getCompletedTasks

-   **Добавлено**: Логирование количества завершенных задач
-   **Добавлено**: Использование `ERROR_CODES.SYSTEM.DATABASE_ERROR`
-   **Улучшено**: Обработка ошибок

### 6. getTotalTaskReward

-   **Переписано**: Заменен `UserTask.sum()` на `findAll()` + ручной подсчет
-   **Добавлено**: Безопасная обработка некорректных данных наград
-   **Добавлено**: Использование `ERROR_CODES.SYSTEM.DATABASE_ERROR`
-   **Улучшено**: Логирование общей награды и количества задач

### 7. getUserTask

-   **Добавлено**: Специфичные коды ошибок:
    -   `ERROR_CODES.TASK.TASK_TEMPLATE_NOT_FOUND` - шаблон задачи не найден
    -   `ERROR_CODES.TASK.TASK_NOT_FOUND` - задача пользователя не найдена
-   **Исправлено**: Использование `taskTemplateId` вместо `taskId`
-   **Улучшено**: Детальное логирование

### 8. getTaskStatus

-   **Добавлено**: Специфичные коды ошибок:
    -   `ERROR_CODES.TASK.TASK_TEMPLATE_NOT_FOUND` - шаблон задачи не найден
    -   `ERROR_CODES.TASK.TASK_NOT_FOUND` - задача пользователя не найдена
-   **Исправлено**: Использование `taskTemplateId` вместо `taskId`
-   **Улучшено**: Логирование статуса задачи

### 9. getUserTaskStats

-   **Добавлено**: Использование `ERROR_CODES.SYSTEM.DATABASE_ERROR`
-   **Улучшено**: Логирование статистики (общее количество, завершенные, активные, процент завершения)

### 10. getTaskStats

-   **Добавлено**: Логирование вызова алиаса
-   **Функциональность**: Остается алиасом для `getUserTaskStats`

## Используемые коды ошибок

### TASK коды

-   `ERROR_CODES.TASK.TASK_NOT_FOUND` - задача пользователя не найдена
-   `ERROR_CODES.TASK.TASK_TEMPLATE_NOT_FOUND` - шаблон задачи не найден
-   `ERROR_CODES.TASK.TASK_ALREADY_COMPLETED` - задача уже завершена (не используется, но доступен)

### SYSTEM коды

-   `ERROR_CODES.SYSTEM.DATABASE_ERROR` - ошибки базы данных

## Улучшения логирования

### Структурированные логи

Все методы теперь используют структурированное логирование с контекстной информацией:

```javascript
logger.debug('methodName on start', { userId, slug });
logger.debug('methodName completed successfully', { userId, result });
logger.error('Failed to methodName', {
	userId,
	error: err.message,
	stack: err.stack,
});
```

### Контекстная информация

-   `userId` - ID пользователя во всех логах
-   `slug` - идентификатор задачи где применимо
-   `taskId` - ID задачи где применимо
-   `error` - сообщение об ошибке
-   `stack` - стек ошибки для отладки

## Обработка ошибок

### Единообразный подход

Все методы используют единообразный подход к обработке ошибок:

```javascript
try {
	// Основная логика
} catch (err) {
	// Логирование ошибки
	logger.error('Failed to methodName', {
		userId,
		error: err.message,
		stack: err.stack,
	});

	// Проверка типа ошибки
	if (err instanceof ApiError) {
		throw err; // Перебрасываем уже созданные ApiError
	}

	// Создание новой ошибки с кодом
	throw ApiError.Internal(
		`Failed to methodName: ${err.message}`,
		ERROR_CODES.SYSTEM.DATABASE_ERROR
	);
}
```

### Graceful degradation

-   Некритичные ошибки не прерывают выполнение
-   Подробная информация об ошибках для отладки
-   Сохранение транзакционной целостности

## Производительность

### Оптимизации

-   Замена `UserTask.sum()` на `findAll()` + ручной подсчет для лучшего контроля
-   Использование транзакций для атомарности операций
-   Параллельные запросы где возможно

### Мониторинг

-   Логирование времени выполнения операций
-   Подсчет количества обработанных записей
-   Отслеживание успешных и неуспешных операций

## Безопасность

### Валидация данных

-   Проверка существования шаблонов задач
-   Валидация входных параметров
-   Безопасная обработка некорректных данных

### Транзакционная безопасность

-   Правильная обработка commit/rollback
-   Поддержка внешних транзакций
-   Изоляция операций

## Обратная совместимость

Все методы сохраняют:

-   Тот же интерфейс (сигнатуры методов)
-   Те же возвращаемые данные
-   Тот же функционал

Изменения касаются только внутренней реализации и улучшения обработки ошибок.

## Тестирование

Рекомендуется обновить тесты для проверки:

-   Правильности кодов ошибок
-   Структурированного логирования
-   Обработки различных сценариев ошибок
-   Транзакционной целостности
