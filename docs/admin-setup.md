# Настройка администраторов и супервайзера

## Обзор

Система Nebulahunt использует двухфакторную аутентификацию Google 2FA для администраторов и супервайзера. Пользователи регистрируются через Telegram бот без 2FA.

## Роли

-   **SUPERVISOR** - Супервайзер с полными правами доступа
-   **ADMIN** - Администратор с ограниченными правами

## Настройка переменных окружения

Добавьте следующие переменные в файл `.env`:

```env
# Email супервайзера для автоматической инициализации
SUPERVISOR_EMAIL=supervisor@yourdomain.com

# Секрет для инициализации администраторов
ADMIN_INIT_SECRET=your_very_secure_admin_init_secret

# Google 2FA настройки
GOOGLE_2FA_ISSUER=Nebulahunt
GOOGLE_2FA_ALGORITHM=SHA1
GOOGLE_2FA_DIGITS=6
GOOGLE_2FA_PERIOD=30
```

## Инициализация супервайзера

Супервайзер автоматически инициализируется при запуске сервера, используя email из переменной `SUPERVISOR_EMAIL`.

### Автоматическая инициализация

При запуске сервера система:

1. Проверяет наличие переменной `SUPERVISOR_EMAIL`
2. Создает аккаунт супервайзера, если он не существует
3. Генерирует Google 2FA секрет
4. Логирует результат инициализации

### Ручная инициализация

Если нужно инициализировать супервайзера вручную:

```bash
curl -X POST http://localhost:5000/admin/supervisor/init
```

## Инициализация администраторов

### Шаг 1: Создание аккаунта администратора

Сначала создайте запись в таблице `admins` с email администратора:

```sql
INSERT INTO admins (email, role) VALUES ('admin@yourdomain.com', 'ADMIN');
```

### Шаг 2: Инициализация с Google 2FA

Отправьте POST запрос для инициализации:

```bash
curl -X POST http://localhost:5000/admin/init \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@yourdomain.com",
    "secretKey": "your_admin_init_secret"
  }'
```

### Шаг 3: Настройка Google Authenticator

В ответе вы получите:

-   `google2faSecret` - секрет для настройки 2FA
-   `otpAuthUrl` - URL для QR-кода

1. Откройте Google Authenticator
2. Нажмите "+" для добавления аккаунта
3. Выберите "Сканировать QR-код" или введите секрет вручную
4. Используйте `otpAuthUrl` для QR-кода или `google2faSecret` для ручного ввода

## Аутентификация администраторов

### Шаг 1: Логин

```bash
curl -X POST http://localhost:5000/admin/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@yourdomain.com"
  }'
```

### Шаг 2: Подтверждение 2FA

```bash
curl -X POST http://localhost:5000/admin/2fa/verify \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@yourdomain.com",
    "otp": "123456"
  }'
```

В ответе вы получите JWT токены для доступа к API.

## Использование API

После успешной аутентификации используйте полученный `accessToken` в заголовке `Authorization`:

```bash
curl -X GET http://localhost:5000/admin/users \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

## Безопасность

### Рекомендации

1. **Секретный ключ**: Используйте сложный секретный ключ для `ADMIN_INIT_SECRET`
2. **Email**: Используйте корпоративные email адреса
3. **2FA**: Всегда включайте Google 2FA для администраторов
4. **Токены**: Храните токены в безопасном месте
5. **Логи**: Регулярно проверяйте логи на подозрительную активность

### Ограничения

-   Инициализация супервайзера: 1 запрос в час
-   Административные операции: 10 запросов в минуту
-   2FA коды действительны 30 секунд с окном ±30 секунд

## Устранение неполадок

### Проблема: "SUPERVISOR_EMAIL not configured"

**Решение**: Добавьте переменную `SUPERVISOR_EMAIL` в файл `.env`

### Проблема: "Invalid 2FA code"

**Решение**:

1. Проверьте время на устройстве (должно быть синхронизировано)
2. Убедитесь, что используете правильный код из Google Authenticator
3. Проверьте, что код не устарел (действителен 30 секунд)

### Проблема: "2FA not enabled for this account"

**Решение**: Убедитесь, что администратор был правильно инициализирован с Google 2FA

### Проблема: "Invalid secret key"

**Решение**: Проверьте, что `ADMIN_INIT_SECRET` в запросе совпадает с переменной окружения

## Логирование

Все операции с администраторами логируются:

-   Успешные и неуспешные попытки входа
-   Инициализация новых администраторов
-   2FA верификация
-   Подозрительная активность

Логи можно найти в файле `logs/app.log`.
