# Архитектура системы

## Обзор

Nebulahant Server построен на основе многослойной архитектуры с четким разделением ответственности между компонентами. Система использует современные технологии и паттерны для обеспечения масштабируемости, надежности и производительности.

## Архитектурные слои

### 1. Presentation Layer (Контроллеры)

-   **Назначение**: Обработка HTTP запросов и ответов
-   **Компоненты**: Express.js контроллеры
-   **Ответственность**:
    -   Валидация входящих данных
    -   Маршрутизация запросов
    -   Форматирование ответов
    -   Обработка ошибок

### 2. Business Logic Layer (Сервисы)

-   **Назначение**: Реализация бизнес-логики приложения
-   **Компоненты**: Сервисные классы
-   **Ответственность**:
    -   Игровая логика
    -   Обработка данных
    -   Валидация бизнес-правил
    -   Координация между компонентами

### 3. Data Access Layer (Модели)

-   **Назначение**: Взаимодействие с базой данных
-   **Компоненты**: Sequelize модели
-   **Ответственность**:
    -   Определение структуры данных
    -   Выполнение запросов к БД
    -   Валидация на уровне данных
    -   Управление связями между таблицами

### 4. Infrastructure Layer (Middleware, Конфигурация)

-   **Назначение**: Обеспечение инфраструктурных функций
-   **Компоненты**: Middleware, конфигурации, утилиты
-   **Ответственность**:
    -   Аутентификация и авторизация
    -   Логирование
    -   Обработка ошибок
    -   Rate limiting

## Диаграмма архитектуры

```
┌─────────────────────────────────────────────────────────────┐
│                    Client (Telegram Mini App)              │
└─────────────────────┬───────────────────────────────────────┘
                      │ HTTPS
┌─────────────────────▼───────────────────────────────────────┐
│                    Express.js Server                        │
├─────────────────────────────────────────────────────────────┤
│  Middleware Layer                                           │
│  ├─ CORS                                                    │
│  ├─ Body Parser                                             │
│  ├─ Cookie Parser                                           │
│  ├─ Rate Limiting                                           │
│  ├─ TMA Authentication                                      │
│  ├─ Admin Authorization                                     │
│  └─ Error Handling                                          │
├─────────────────────────────────────────────────────────────┤
│  Router Layer                                               │
│  ├─ /auth/*                                                 │
│  ├─ /admin/*                                                │
│  ├─ /galaxy/*                                               │
│  ├─ /artifact/*                                             │
│  ├─ /market/*                                               │
│  ├─ /state/*                                                │
│  ├─ /upgrades/*                                             │
│  ├─ /events/*                                               │
│  └─ /tasks/*                                                │
├─────────────────────────────────────────────────────────────┤
│  Controller Layer                                           │
│  ├─ UserController                                          │
│  ├─ AdminController                                         │
│  ├─ GalaxyController                                        │
│  ├─ ArtifactController                                      │
│  ├─ MarketController                                        │
│  ├─ StateController                                         │
│  ├─ UpgradeController                                       │
│  ├─ EventController                                         │
│  └─ TaskController                                          │
├─────────────────────────────────────────────────────────────┤
│  Service Layer                                              │
│  ├─ UserService                                             │
│  ├─ StateService                                            │
│  ├─ GalaxyService                                           │
│  ├─ ArtifactService                                         │
│  ├─ MarketService                                           │
│  ├─ UpgradeService                                          │
│  ├─ EventService                                            │
│  ├─ TaskService                                             │
│  ├─ TokenService                                            │
│  └─ LoggerService                                           │
├─────────────────────────────────────────────────────────────┤
│  Model Layer                                                │
│  ├─ User                                                    │
│  ├─ UserState                                               │
│  ├─ Galaxy                                                  │
│  ├─ Artifact                                                │
│  ├─ MarketOffer                                             │
│  ├─ MarketTransaction                                       │
│  ├─ PaymentTransaction                                      │
│  ├─ PackageStore                                            │
│  ├─ UpgradeNode                                             │
│  ├─ Task                                                    │
│  ├─ GameEvent                                               │
│  └─ Token                                                   │
└─────────────────────┬───────────────────────────────────────┘
                      │ SQL
┌─────────────────────▼───────────────────────────────────────┐
│                    PostgreSQL Database                      │
│  ├─ users                                                   │
│  ├─ userstates                                             │
│  ├─ galaxies                                               │
│  ├─ artifacts                                              │
│  ├─ marketoffers                                           │
│  ├─ markettransactions                                     │
│  ├─ paymenttransactions                                    │
│  ├─ packagestore                                           │
│  ├─ upgradenodes                                           │
│  ├─ tasks                                                  │
│  ├─ gameevents                                             │
│  └─ tokens                                                 │
└─────────────────────────────────────────────────────────────┘
```

## Поток данных

### 1. Входящий запрос

```
Client Request → Express Server → Middleware Chain → Router → Controller
```

### 2. Обработка бизнес-логики

```
Controller → Service Layer → Model Layer → Database
```

### 3. Исходящий ответ

```
Database → Model Layer → Service Layer → Controller → Response
```

## Компоненты системы

### Express.js Framework

-   **Версия**: 5.1.0
-   **Назначение**: Веб-фреймворк для обработки HTTP запросов
-   **Особенности**:
    -   Асинхронная обработка
    -   Middleware архитектура
    -   Роутинг
    -   Обработка ошибок

### Sequelize ORM

-   **Версия**: 6.37.7
-   **Назначение**: ORM для работы с PostgreSQL
-   **Особенности**:
    -   Миграции
    -   Валидация моделей
    -   Связи между таблицами
    -   Транзакции
    -   JSONB поддержка

### PostgreSQL Database

-   **Версия**: 12+
-   **Назначение**: Основная база данных
-   **Особенности**:
    -   JSONB для сложных структур
    -   Индексы для производительности
    -   Транзакции ACID
    -   Масштабируемость

### JWT Authentication

-   **Библиотека**: jsonwebtoken
-   **Назначение**: Аутентификация пользователей
-   **Особенности**:
    -   Access и Refresh токены
    -   Автоматическое обновление
    -   Безопасное хранение

### Telegram Mini Apps Integration

-   **Библиотека**: @telegram-apps/init-data-node
-   **Назначение**: Интеграция с Telegram
-   **Особенности**:

### Система инициализации

-   **Автоматическая инициализация**: При запуске сервера
-   **Компоненты**:
    -   Синхронизация схемы базы данных
    -   Инициализация комиссий маркета
    -   Создание системного пользователя
-   **Конфигурация**: `config/market.config.js`, `config/constants.js`
-   **Безопасность**: Транзакционное выполнение операций
    -   Верификация данных от Telegram
    -   Безопасная аутентификация
    -   Получение данных пользователя

### Pino Logging

-   **Версия**: 9.7.0
-   **Назначение**: Централизованное логирование
-   **Особенности**:
    -   Высокая производительность
    -   Структурированные логи
    -   Настраиваемые уровни
    -   Pretty printing для разработки

## Паттерны проектирования

### 1. MVC (Model-View-Controller)

-   **Model**: Sequelize модели
-   **View**: JSON ответы API
-   **Controller**: Express контроллеры

### 2. Service Layer Pattern

-   Инкапсуляция бизнес-логики
-   Переиспользование кода
-   Тестируемость
-   Разделение ответственности

### 3. Repository Pattern

-   Абстракция доступа к данным
-   Инкапсуляция SQL запросов
-   Легкость тестирования

### 4. Middleware Pattern

-   Цепочка обработки запросов
-   Модульность
-   Переиспользование логики

### 5. Dependency Injection

-   Внедрение зависимостей
-   Слабая связанность
-   Тестируемость

## Безопасность

### Аутентификация

-   Telegram Mini Apps интеграция
-   JWT токены с истечением срока
-   Refresh token rotation

### Авторизация

-   Ролевая модель (USER, ADMIN, SYSTEM)
-   Middleware для проверки прав
-   Защита административных функций

### Валидация данных

-   Express-validator для входящих данных
-   Валидация на уровне моделей
-   Санитизация пользовательского ввода

### Rate Limiting

-   Ограничение запросов по IP
-   Настраиваемые лимиты
-   Защита от DDoS атак

## Производительность

### Оптимизации базы данных

-   Индексы для часто используемых полей
-   JSONB для сложных структур
-   Оптимизированные запросы

### Кэширование

-   In-memory кэширование для статических данных
-   Оптимизация запросов к БД

### Асинхронная обработка

-   Неблокирующие операции
-   Обработка ошибок
-   Graceful degradation

## Масштабируемость

### Горизонтальное масштабирование

-   Stateless архитектура
-   Внешняя база данных
-   Load balancing готовность

### Вертикальное масштабирование

-   Оптимизация запросов
-   Индексы
-   Мониторинг производительности

## Мониторинг и логирование

### Структурированное логирование

-   JSON формат логов
-   Уровни логирования
-   Контекстная информация

### Метрики

-   Время отклика API
-   Количество запросов
-   Ошибки и исключения
-   Использование ресурсов

### Health Checks

-   Проверка состояния сервиса
-   Проверка подключения к БД
-   Мониторинг зависимостей

## Развертывание

### Контейнеризация

-   Docker образы
-   Multi-stage builds
-   Оптимизация размера

### CI/CD

-   Автоматические тесты
-   Линтинг кода
-   Автоматическое развертывание

### Environment Management

-   Переменные окружения
-   Конфигурационные файлы
-   Безопасное хранение секретов

## Тестирование

### Unit Tests

-   Тестирование отдельных компонентов
-   Mocking зависимостей
-   Покрытие кода

### Integration Tests

-   Тестирование API эндпоинтов
-   Тестирование базы данных
-   End-to-end сценарии

### Performance Tests

-   Нагрузочное тестирование
-   Стресс-тестирование
-   Профилирование производительности

## Будущие улучшения

### Микросервисная архитектура

-   Разделение на отдельные сервисы
-   API Gateway
-   Service Discovery

### Event-Driven Architecture

-   Асинхронная обработка событий
-   Message queues
-   Event sourcing

### GraphQL API

-   Гибкие запросы
-   Типизированная схема
-   Оптимизация запросов

### Real-time функциональность

-   WebSocket соединения
-   Server-Sent Events
-   Live обновления

---

Эта архитектура обеспечивает надежную, масштабируемую и поддерживаемую основу для игры Nebulahant, позволяя легко добавлять новые функции и адаптироваться к растущим потребностям пользователей.

**UserState** — основная модель для хранения состояния пользователя. Все игровые параметры, события, задачи и апгрейды пользователя теперь централизованно хранятся в JSONB-полях этой таблицы. Таблицы UserEvent, UserTask, UserUpgradeNode удалены, их данные перенесены в UserState.

**UpgradeNode** и **Task** — глобальные шаблоны (справочники), не имеют связи с User. Прогресс и состояние пользователя по задачам и апгрейдам хранятся только в UserState.
