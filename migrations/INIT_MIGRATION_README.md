# Миграции для инициализации новой базы данных

Этот набор миграций создает полную структуру базы данных для проекта NebulaHunt с оптимизацией производительности и отложенными ограничениями.

## Структура миграций

Миграции разделены на 9 логических частей:

### 1. `20250101000001-init-core-tables.js`

**Основные таблицы пользователей и состояний**

-   `users` - таблица пользователей
-   `userstates` - состояния пользователей (ресурсы, параметры)
-   `tokens` - токены аутентификации

### 2. `20250101000002-init-galaxy-artifact-tables.js`

**Таблицы галактик и артефактов**

-   `galaxies` - галактики пользователей
-   `artifacttemplates` - шаблоны артефактов
-   `artifacts` - артефакты пользователей

### 3. `20250101000003-init-template-tables.js`

**Таблицы шаблонов**

-   `upgradenodetemplates` - шаблоны апгрейдов
-   `tasktemplates` - шаблоны задач
-   `eventtemplates` - шаблоны событий
-   `packagetemplates` - шаблоны пакетов

### 4. `20250101000004-init-user-data-tables.js`

**Пользовательские данные**

-   `userupgrades` - апгрейды пользователей
-   `usertasks` - задачи пользователей
-   `userevents` - события пользователей
-   `usereventsettings` - настройки событий пользователей
-   `packagestore` - пакеты пользователей

### 5. `20250101000005-init-market-tables.js`

**Рыночные таблицы**

-   `marketoffers` - рыночные предложения
-   `markettransactions` - рыночные транзакции
-   `paymenttransactions` - платежные транзакции
-   `marketcommissions` - комиссии рынка

### 6. `20250101000006-init-admin-tables.js`

**Административные таблицы**

-   `admins` - администраторы
-   `admintokens` - токены администраторов
-   `admininvites` - приглашения администраторов

### 7. `20250101000007-add-additional-indexes.js`

**Дополнительные индексы для оптимизации**

-   Индексы для всех основных полей
-   Составные индексы для сложных запросов
-   Индексы для сортировки и фильтрации

### 8. `20250101000008-create-views.js`

**View для оптимизации запросов**

-   `user_statistics` - статистика пользователей
-   `active_market_offers` - активные рыночные предложения
-   `transaction_statistics` - статистика транзакций
-   `user_achievements` - достижения пользователей
-   `active_user_events` - активные события пользователей
-   `artifact_statistics` - статистика артефактов
-   `market_activity` - рыночная активность
-   `admin_statistics` - административная статистика
-   `user_progress` - прогресс пользователей
-   `financial_statistics` - финансовая статистика

### 9. `20250101000009-finalize-constraints.js`

**Финальная активация ограничений**

-   Активация всех отложенных внешних ключей
-   Создание проверок целостности данных
-   Создание GIN индексов для JSONB полей
-   Создание специализированных индексов для производительности

## Особенности реализации

### Отложенные ограничения (Deferred Constraints)

Все внешние ключи создаются с отложенной проверкой (`INITIALLY_DEFERRED`), что позволяет:

-   Создавать таблицы в любом порядке
-   Избежать ошибок при циклических зависимостях
-   Активировать все ограничения в конце процесса

### Оптимизация производительности

-   **GIN индексы** для JSONB полей
-   **Частичные индексы** для фильтрованных данных
-   **Составные индексы** для сложных запросов
-   **Индексы для полнотекстового поиска**
-   **Индексы для временных рядов**
-   **Индексы для агрегации**

### Проверки целостности данных

-   Проверка положительных значений ресурсов и цен
-   Проверка корректных диапазонов значений
-   Проверка корректности дат
-   Проверка валидности ENUM значений

## Использование

### Запуск миграций

```bash
# Запуск всех миграций
npx sequelize-cli db:migrate

# Запуск конкретной миграции
npx sequelize-cli db:migrate --to 20250101000009-finalize-constraints.js

# Откат миграций
npx sequelize-cli db:migrate:undo:all
```

### Проверка состояния

```bash
# Проверка статуса миграций
npx sequelize-cli db:migrate:status

# Проверка структуры базы данных
npx sequelize-cli db:describe
```

## Структура базы данных

### Основные сущности

1. **Пользователи** (`users`, `userstates`, `tokens`)
2. **Игровые объекты** (`galaxies`, `artifacts`)
3. **Шаблоны** (`artifacttemplates`, `upgradenodetemplates`, `tasktemplates`, `eventtemplates`, `packagetemplates`)
4. **Пользовательские данные** (`userupgrades`, `usertasks`, `userevents`, `usereventsettings`, `packagestore`)
5. **Рынок** (`marketoffers`, `markettransactions`, `paymenttransactions`, `marketcommissions`)
6. **Администрирование** (`admins`, `admintokens`, `admininvites`)

### Ключевые особенности

-   **JSONB поля** для гибкого хранения конфигураций
-   **ENUM типы** для строгой типизации
-   **Временные метки** для всех записей
-   **Мягкое удаление** через флаги `active`
-   **Аудит** через поля `created_at`, `updated_at`

## Производительность

### Оптимизированные запросы

-   Статистика пользователей через view
-   Агрегация данных через специализированные индексы
-   Быстрый поиск через полнотекстовые индексы
-   Эффективная фильтрация через частичные индексы

### Мониторинг

-   Индексы для отслеживания истекающих событий
-   Индексы для мониторинга безопасности
-   Индексы для статистических запросов

## Безопасность

### Проверки данных

-   Валидация всех числовых значений
-   Проверка корректности дат
-   Контроль ENUM значений
-   Проверка целостности связей

### Аудит

-   Логирование всех транзакций
-   Отслеживание изменений ресурсов
-   Мониторинг административных действий

## Поддержка

При возникновении проблем:

1. Проверьте логи миграций
2. Убедитесь в корректности подключения к БД
3. Проверьте права доступа пользователя БД
4. При необходимости выполните откат и повторный запуск

## Дополнительные возможности

### Расширение структуры

Миграции созданы модульно, что позволяет легко добавлять новые таблицы и индексы без нарушения существующей структуры.

### Масштабирование

Структура оптимизирована для работы с большими объемами данных и высокими нагрузками.

### Мониторинг

Встроенные view и индексы позволяют эффективно отслеживать состояние системы и производительность.
