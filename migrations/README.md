# Миграции базы данных Nebulahunt

## Обзор

Этот каталог содержит миграции базы данных для проекта Nebulahunt Server. Миграции организованы в логические группы и выполняются последовательно для создания и обновления структуры базы данных.

## Структура миграций

## Логические группы таблиц

### Основные таблицы

-   **users** - Информация о пользователях
-   **userstates** - Состояние пользователя с JSONB полями для хранения игровых данных
-   **tokens** - Токены авторизации

### Игровые таблицы

-   **galaxies** - Галактики
-   **artifacts** - Артефакты

### Таблицы шаблонов

-   **UpgradeNodeTemplates** - Шаблоны апгрейдов
-   **tasktemplates** - Шаблоны заданий
-   **eventtemplates** - Шаблоны событий

### Рыночные таблицы

-   **marketoffers** - Предложения на рынке
-   **markettransactions** - Транзакции на рынке
-   **paymenttransactions** - Платежные транзакции
-   **marketcommissions** - Комиссии рынка (управляются через админ-панель)

### Таблицы пакетов

-   **packagetemplates** - Шаблоны пакетов
-   **packagestore** - Хранилище пакетов пользователя

## Особенности миграций

1. **Индексы** - Для всех внешних ключей и часто используемых полей созданы индексы
2. **Ограничения** - Настроены ограничения внешних ключей с каскадным удалением/обновлением
3. **JSONB поля** - Для хранения сложных структур данных используются JSONB поля
4. **Комментарии** - Каждая таблица и поле имеют комментарии для лучшего понимания

## Запуск миграций

### С использованием Sequelize CLI

```bash
# Запуск всех миграций
npx sequelize-cli db:migrate

# Откат последней миграции
npx sequelize-cli db:migrate:undo

# Откат всех миграций
npx sequelize-cli db:migrate:undo:all
```

### С использованием Docker

```bash
# Запуск миграций через Docker Compose
docker-compose -f docker-compose.migrate.yml up --abort-on-container-exit

# Или с использованием скрипта
./docker-scripts.sh migrate
```

## Связи между таблицами

```

users
 ├── userstates (1:1)
 ├── tokens (1:n)
 ├── galaxies (1:n)
 ├── artifacts (1:n)
 ├── marketoffers (1:n)
 └── packagestore (1:n)

marketoffers
 ├── markettransactions (1:n)
 └── paymenttransactions (1:n)

packagetemplates
 └── packagestore (1:n через логику в сервисе)


```

## Важные замечания

1. **UserState** - Центральная таблица для хранения игрового состояния пользователя. Использует JSONB поля для хранения:

    - `tasks` - Прогресс и состояние заданий пользователя
    - `events` - События пользователя
    - `upgrades` - Апгрейды пользователя
    - `settings` - Настройки пользователя
    - `lockedResources` - Заблокированные ресурсы

2. **Шаблоны** - TaskTemplate, EventTemplate, UpgradeNodeTemplate и PackageTemplate являются глобальными шаблонами и не имеют прямой связи с конкретным пользователем. Они используются как справочники для создания экземпляров в UserState.

3. **Транзакции** - Все миграции выполняются в транзакциях для обеспечения целостности данных.

## Порядок выполнения миграций

Миграции должны выполняться строго в порядке их номеров. Система миграций Sequelize автоматически отслеживает выполненные миграции в таблице `SequelizeMeta`.

## Обратная совместимость

При обновлении схемы базы данных необходимо создавать новые миграции с более поздними датами. Не рекомендуется изменять существующие миграции, так как это может привести к несовместимости с уже развернутыми базами данных.

## Дополнительная информация

Более подробную информацию о моделях данных и их взаимосвязях можно найти в файле `docs/models.md`.
