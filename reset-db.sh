#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö API –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./reset-db.sh

CONTAINER_NAME="nebulahunt-api"

echo "=========================================="
echo "üîÑ –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"
echo "=========================================="
echo ""

echo "üõë –®–∞–≥ 1/6: –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
docker stop $CONTAINER_NAME || echo "‚ö†Ô∏è  –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
echo ""

echo "üóëÔ∏è  –®–∞–≥ 2/6: –û—á–∏—â–∞—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö..."
echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ —É–¥–∞–ª–∏—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ!"
docker exec -it $CONTAINER_NAME npm run clear-db
if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –ë–î. –í–æ–∑–º–æ–∂–Ω–æ, –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω."
    echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
    docker start $CONTAINER_NAME
    sleep 5
    docker exec -it $CONTAINER_NAME npm run clear-db
fi
echo ""

echo "üì¶ –®–∞–≥ 3/6: –ó–∞–ø—É—Å–∫–∞—é –º–∏–≥—Ä–∞—Ü–∏–∏..."
docker exec -it $CONTAINER_NAME npm run migrate:prod
if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π"
    exit 1
fi
echo ""

echo "üöÄ –®–∞–≥ 4/6: –ó–∞–ø—É—Å–∫–∞—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è system user..."
docker start $CONTAINER_NAME
echo "‚è≥ –ñ–¥—É 15 —Å–µ–∫—É–Ω–¥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è system user..."
sleep 15
echo ""

echo "üõë –®–∞–≥ 5/6: –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
docker stop $CONTAINER_NAME
echo ""

echo "üå± –®–∞–≥ 6/6: –ó–∞–ø—É—Å–∫–∞—é seeders..."
docker exec -it $CONTAINER_NAME npm run seed
if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ seeders"
    echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏..."
    docker start $CONTAINER_NAME
    exit 1
fi
echo ""

echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ..."
docker start $CONTAINER_NAME
echo ""

echo "=========================================="
echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
echo "=========================================="
echo ""
echo "üìã –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏:"
echo "   docker logs $CONTAINER_NAME --tail 50"
echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä—å health endpoint:"
echo "   curl http://127.0.0.1:3002/api/health"
echo ""

